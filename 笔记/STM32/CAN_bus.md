> 1、CAN：现场总线，有效的支持分布式控制系统的串行通信总线；
> 2、CAN总线利用差分电平进行数据传输，信号线为CAN_H,CAN_L；
> 3、CAN通信包含两种格式的报文，标准格式以及拓展格式；
> 4、CAN总线上的一个节点，必然包含收发器和控制器；
> 5、CAN总线上的电平分为显性和隐形，显性为逻辑0，隐形为逻辑1；
> 6、CAN总线同样有高速和低速总线的区别；

### 1、逻辑电平
		CAN总线中显性电平为逻辑0，隐形电平为逻辑1。
		高速总线中，表示显性电平（逻辑0）时，CAN_H>CAN_L，且CAN_H-CAN_L>2V。表示隐形电平时，CAN_H≈CAN_L，两者之间的电压差接近为0。

![[Pasted image 20230821093605.png]]

		低速总线中，显性电平（逻辑0）时，CAN_H>CAN_L，且CAN_H - CAN_L > 2V；表示隐性电平时，CAN_H<CAN_L，且CAN_H - CAN_L < -1.5V。

![[Pasted image 20230824112911.png]]

### 2、节点结构
		CAN总线上允许挂在多个设备，这些设备任何人都可以是从机或者主机。它们的基本结构都类似。必然包好：
		1、CAN接收器
		2、CAN控制器
		3、处理单元

![[Pasted image 20230824115018.jpg]]

		 发送过程中，CAN收发器负责将来自CAN控制器的逻辑电平转换成CAN的差分电平；接收过程，CAN收发器则将收到的差分电平转换成逻辑电平送入CAN控制器。

### 3、总线特性

		前面提到，CAN总线上的所有节点都可以是主机或者从机，所有节点在总线空闲的状态下，都可以向向总线索取控制权。多个节点之间的数据信息依据先来后到的顺序利用总线收发数据。如果多个节点同时希望占用总线，将会发生总线竞争，这时候需要一个合理的总线仲裁机制。

#非破坏性仲裁机制
>_非破坏性仲裁机制，指的是，既不会造成已经发送的数据延迟，也不会破坏已经发送的数据的仲裁机制，最大的特点是，总线的线与机制。和遗传因子一样，显性性状会覆盖掉隐性性状。CAN总线上的显性电平（逻辑0）会覆盖掉隐形电平（逻辑1）。通俗的理解，就是电路通路上有一个点接地，那么整个通路电压就都接地了。_

		那么，当多个节点，竞争总线的时候，率先出现隐形电平的节点，将会被迫推出总线竞争。想要更加明朗的例子，需要先了解CAN总线的数据帧结构。

##### CAN的数据结构

将发送数据的节点，称为“发送单元”
将接收数据的节点，称为“接收单元”

|帧|帧用途|
|:---:|:---:|
|数据帧|发送单元向接收单元发出的实际数据|
|遥控帧(远程帧)|接收单元向有相同ID的发送单元的请求|
|错误帧|检测帧错误时通知其他单元|
|过载帧|接收单元尚未做好接收准备|
|帧间隔|分离数据帧和之前的遥控帧|

_逐个进行分析：_

#数据帧
>		数据帧包含的内容相当长一段。包括有
>		1、帧起始，这是一个显性位，只有当总线空闲，节点才能发起
>		2、仲裁段，这一段时同时发起总线竞争的节点之间进行总线仲裁的依据，它包括：
>				- ID
>				- RTR
>				- IDE（拓展格式专属）
>				- SRR（拓展格式专属）
>		3、控制段，主要用于表示数据段的字节个数
>				- r1\r0
>				- DLC
>		4、数据段，CAN通信主要发送的数据内容
>		5、CRC段
>				- CRC校验位
>				- DEL界定符
>		6、AC段端，主机用于确定报文至少被一个节点正确接收
>		7、帧结束段，11个连续的隐形位，之后总线进入空闲

_CAN通信分为标准格式和拓展格式，两种格式下，在数据帧中的某些部分存在些许差异。_
**标准格式如下：（图中R0为IDE）**
![[Pasted image 20230824153242.png]]

_数据帧的拓展格式和标准格式之间，最大差异在于仲裁段。在仲裁段中，标准格式在11位ID结束后，就会进入RTR位，而拓展格式，则会进入SRR位。_

单独取出仲裁段做对比：

![[Pasted image 20230824160935.png]]


		CAN通信中，两个帧之间发生仲裁时，ID位谁先出现隐形电平，谁就会退出总线的竞争，因此，ID号越小的数据帧的优先级是越高的。如果竞争的两个帧格式不同，但恰好前11位ID相同，则由SRR和RTR位来结束这场争斗。
		RTR的作用，是用于区分数据帧和遥控帧(远程帧)。如果在同一条总线上，标准格式和拓展格式进行竞争。比较到RTR时，拓展格式还未结束ID对比。因此，在拓展格式ID的第11位后，添加了这个一个SRR填充位。该位在拓展格式中固定为1。但并不是表示这一个拓展格式数据帧是远程帧。单纯只是为了让数据帧之间位置对应。
		正是因为SRR这个位的存在，在数据帧的竞争中，标准格式总会在仲裁中胜出。
		
		对于发送者，自然知道谁是拓展帧，谁是标准帧。接收者如何区分这两种格式的帧呢？R0位，也就是IDE位承担这个责任。在标准帧中没有R0位，RTR后直接是IDE位。同理SRR同理，为了保持标准帧和拓展帧的统一，拓展帧的SRR后是IDE位，控制场保持一致而补充了R0位。
		接收者，通过判断ID位后的IDE位，来区分这个帧，后续应该按照标准格式解析还是拓展格式解析。IDE为0，此帧为标准格式，IDE为1，此帧为拓展格式。
		总结：
		1、拓展格式SRR位，是总线竞争时区分标准格式和拓展格式的。SRR位使得拓展格式在总线竞争时处于不利地位。
		2、IDE时用给接收方判断收到的数据，时标准格式还是拓展格式。为了保证数据的对其性，拓展格式将IDE放在SRR之后，由控制段转入了仲裁段，而控制段IDE的原来位置则有一个显性电平R0(有些资料时R1)代替。

---

#遥控帧（远程帧

		数据帧如果去掉携带的数据，就是一个遥控帧。一般用于某个节点向另一个节点发出ACK回应。
		1、不同帧之间竞争总线
		在遥控帧中，RTR位为1，隐形电平。因此，相同格式的数据帧和遥控帧进行竞争时，遥控帧不占优势，会因为RTR位而推出总线竞争。
		2、同为遥控帧，竞争总线。
			2.1、ID越小的帧，优先级越高
			2.2、前11位ID相同的情况下，由于SRR位，拓展格式在总线竞争中处理劣势。

#### ACK段
		因为和数据帧相同，因此数据帧的ACK段也在此处总结。
		ACK段用来监测数据是否被正确接收，它由ACK槽(ACK plot)和ACK界定符组成，共2个位。
		1、发送者
			发送者会在ACK段发送两个隐形位，也就是ACK槽和ACK界定符都是1。
		2、接收者
			接收者正确收到数据后，回复发送者时，会将ACK槽的电平改为显性电平0。


---
#错误帧

>		错误帧区别于前两种，更为复杂一些。首先要知道，CAN通信什么情况下会发出错误帧：

|错误|描述|
|:---:|:---:|
|位错误|输出电平和总线电平不一致|
|填充错误|填充段落内，连续监测到6个相同电平|
|CRC错误|接收数据CRC校验和CRC段结果存在差异|
|格式错误|格式固定位的电平不正确|
	|ACk错误|发送单元在ACK槽中监测到隐性电平|

#位错误

		这个错误是发送者在发送数据时，进行自我回读。如果回读数据出现偏差，则会产生位错误帧。可以理解为，发一位读有自己读一位，如果发出显性而读到隐形，或者发出隐形而读到显性，则会认为是位错误。
		但是，当处于仲裁段，或者ACK段时如果发出显性位而回读到隐形位，并不会认为是位错误。位错误监测持续在整个数据帧或者遥控帧的发送过程。
		仲裁段中，如果发送隐性，却读到显性位，说明时节点在仲裁竞争中被淘汰。这个节点会停止发送后续的数据。等待下一次仲裁竞争。
		在ACK段，ACK槽发送隐性却得到显性位，说明节点发送的数据得到了回应。

#格式错误

		格式错误是在固定的位处，监测到非此位应有的电平，就会产生格式错误。例如ACK界位符，此位固定位一个隐形电平，但检测到显性就会出现格式错误。

#ACK错误

	   ACK错误，是在报文发出ACK位后，进行回读，监测不到ACK位变为显性，认为此消息没有人接收到，就会出现ACK错误。

#填充错误

	    CAN通信如果持续发送5个相同的电平，会在下一个电平之间填充一个反向电平。例如，节点1连续的发送了5个相同的显性电平，在发送下一个数据之前，发送者会先发送一个隐形电平做填充。
		如果此时发送者回读监测到了连续多个(6个及以上)相同的电平，就认为是填充错误。
			位填充机制，只会在数据帧和遥控帧的SOF~CRC段发生。

#CRC错误

		接收节点会对收到的数据进行CRC校验，等待和发送节点发送的CRC数据进行匹配，如果CRC匹配错误，接收者会发出CRC错误。

---
_**首先理解错误帧的发送时机：CAN协议规定，当监测到位错误，填充错误，ACK错误或者格式错误时，在错误产生的下一位就会开始发送错误帧。CRC错误则是在ACK界定符之后紧跟着发送。**_
 
		错误帧的格式简单，例如，当节点1，发送数据回读的过程之中，出现了位错误。那么，在下一个瞬间，他会发送出6个连续的显性位，称为主动错误标志，之后会送出6个连续的隐形位，成为被动错误标志，然后再送出8个隐形位，称为错误界定符。注意，这里的连续不会发生位填充规则。

以一个图示为例子：
![[Pasted image 20230824174527.png]]

		节点A是当前总线的控制者，再发送显性位的ACK控制符时，回读总线，发现位隐性。这时候，节点A会立刻停止数据/遥控帧的发送，转而发送6个连续的显性电平。
		总线上的其他节点，监测到这6个显性电平之后，同样会发出6个显性电平。之后发出错误界定符。总线上因此会存在
		有节点A发出的主动错误帧的6个显性电平，和由节点B\C发出的6个显性电平，在有8个错误界定符。之后总线进入一个间歇状态。结束后开启下一次总线竞争。
		有时，不等总线6个错误显性发出，其他节点也发现了总线的错误，此时，节点A主动错误帧之后的6个显性电平没有发完，其它节点就已经开始发送6个错误标志了，因此会有错误重叠部分，这个部分约0-6个。


![[Pasted image 20230824175643.png]]


---
#过载帧

			过载帧由6个显性位和8个过载界定符组成。该帧由发送节点发出，表示节点的接收能力达到了上限，需要停止缓冲一下。过载帧和错误帧的组成太相似了，但是过载帧，只会在帧间隔的器件产生。
			过载帧是接收单元在3个隐性电平的帧间隔期间，监测到显性电平，这个显性电平会被接收单元认为是SOF，起始位，认为有发送单元想要发送数据，这个时候接收单元就会发送过载帧，打断这种发送。

### 4、错误的类别
>CAN的错误类别有
>1、主动错误
>2、被动错误
>主动错误帧和被动错误帧略有差异。区分两种错误的是错误标志段，
>什么情况下，节点会发送主动错误帧？
>什么情况下，节点会发送被动错误帧？

		要进一步理解错误帧，需要了解节点的状态。位于CAN总线上的节点的状态，始终在一线三者之一：
		1、主动错误状态
		发送节点，或者是接收节点，监测到总线状态错误，就会发送带有主动错误标注的主动错误帧。这种状态下的节点，是可以进行正常通信的。
		2、被动错误状态
			这个状态的节点，会等待总线出现主动错误帧，然后自身回应被动错误帧后，参与总线竞争，若竞争成功，则会进入主动错误状态。
		被动错误的节点，即使监测到总线上的数据出现了错误，也不能主动发出错误，只有等待主动错误节点发出主动错误帧。如果没有主动错误帧，总线也不会认为是主动错误状态。
		被动错误节点，监测到错误输出被动错误帧后，不能马上竞争总线，在帧间隔期间，他要先发送一些延迟传送帧，这个帧由8个隐性电平组成。
		3、总线关闭态
		总线关闭态的节点，是禁止在总线上参与接收和发送的。
		
![[Pasted image 20230825145614.jpg]]

		首先每个CAN节点，都会有一个TEC和REC计数器，分别是，发送出错计数和接收出错计数。（Transmit Error Counter & Recvice Error Counter）
		1、这两个计数器，在初始情况下，大家都是0。
		2、依据上图，也就是最开始，总线上所有的节点，都是主动错误状态。他们可以检测总线上出现的错误，并主动发出错误帧。这个错误帧的前6个电平均为显性电平。表示主动错误帧。
		3、经过一段时间的总线仲裁后，总线上势必会出现发送单元和接收单元。发送单元控制这总线的电平变化，而接收单元被动读取总线的电平变化。
		4、此时，他们依旧都是主动错误状态。发送者可以回读自己的数据，发现错误发出主动错误帧。接收者可以读总线的数据，发现错误也发出主动错误帧。
		5、待帧间隔后，总线开启新一轮竞争。
---

>*处于主动错误状态的发送单元*
>A、它可以回读自己的数据，如果出错发出主动错误帧；
>B、它如果监测到别人的主动错误帧，也发出主动错误帧；
>- 无论是AB的哪一种情况，它都是会被总线认为发送有问题，TEC会+8；
>- 如果它在发出主动错误标志时（6个0），回读自身，如果发现问题，TEC+8;
>- 它在监测到被动错误标志后，如果监测到8个显性，TEC+8;
>- 如果它发出过载标志时（6个0），回读自身，如果发现错误，TEC+8;
>- 如果上述两个标志开始，错误达到14个0，每增加8个0，TEC/REC+8；
>- 正常发送一次数据，TEC-1;
>_TEC一旦超过127,他将进入被动错误状态_

---

>_处于被动错误的发送单元_
>A、它发送数据后，即使回读发现了自己的错误，也只能等待总线出现主动错误帧后，发送被动错误帧；
>- 发送被动错误帧，它的TEC+8；
>- 发送被动错误标志后，监测到8个1，TEC+8;
>- 监测到被动错误标志后，回读出现8个显性位，REC+8；
>- 正常发送一次数据，TEC-1;

---
>_处于主动错误状态的接收单元_
>A、接收数据时，发现错误，可以发出主动错误帧
>B、接收数据时，发现主动错误帧，可以发出主动错误帧
>1、无论AB那种情况，自身的REC都会+1，总线不排除是它读功能出现问题；
>2、发出主动错误标识后，理论会监测到隐性的错误标识，如果监测到显性，则REC+8
>3、主动错误标识或者过载标识过程中，回读出错，REC+8;
>4、监测到被动错误标志后，回读出现8个显性位，REC+8；
>5、正常接收数据，REC-1；

---
>_处于被动错误状态的接收单元_
>A、接收数据即使发现错误，只有发现主动错误标识后，才能发出被动错误帧
>1、只要发出错误帧，即使是被动REC也+1；
>2、发出被动错误标识后，理论会检测到隐性的错误界定符，如果监测显性，REC+8;
>4、监测到被动错误标志后，回读出现8个显性位，REC+8;
>5、主动错误标志位后，读14个0后，每出现8个0，REC+8;
>6、正常接收数据，REC=127;


---

			从三角图看，如果发送一直出错，就会被总线打入冷宫。而接收一直出错，只会禁止节点的主动纠错能力。
			被动错误的节点，只要有一次接收正常，就能有机会重回主动错误状态。


---

#### 帧间隔
>帧间隔是用于数据帧、遥控帧之间的延时。帮助节点正确的区分各个帧。
>1、数据帧、遥控帧之前，必然有帧间隔；
>2、错误帧和过载帧之前是不会有帧间隔；
>3、帧间隔之后，总线会进入空闲，也就是主动错误状态的节点之间竞争总线；
>4、进入空闲之前和帧间隔之后，其实还有8个位的延迟传送

		为什么需要8个隐性电平的延迟传送呢？
		假如，如今总线上有3个CAN节点，A、B、C。当前获得总线控制权的节点为节点A。
		首先，节点判断总线空闲的条件是，在总线线上最低连续读取到11个隐性电平。错位帧和帧结束，都有7-8个连续的隐性电平，加上帧间隔，足足有10-11个隐性电平。假如此时，控制总线的（主动错误状态）节点A出错，它将发送6个显性电平后，回读到8-14个隐性电平。而对于其他节点。他们会从6个显性电平后，开始发送6个隐性/显性电平，他们回读到8个隐性电平。可见，读到更多隐性电平的节点A，将会优先判断总线空闲，如此，节点A将有机会优先抢夺总线，发送一个显性的帧起始，这样极有可能打断其他判断总线空闲的节点的判断。如果节点A在这次出错后进入被动错误状态，则和总线指定的规则冲突。因此，必须再延迟几个隐性电平，保证其他节点一定能够进入总线竞争。
