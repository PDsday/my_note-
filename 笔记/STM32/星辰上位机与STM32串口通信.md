		星辰上位机的7byte数据码有参考Modbus_RTU，但不完全相同。同时使用的CRC校验方法为CRC_CCITI16，此方法有多多种实现思路，星辰使用长查表法。

### 上位机数据帧结构：

以一个温度采集数据帧为例：

|01|00|0E|0000|B150|
|:---:|:---:|:---:|:---:|:---:|
|地址码|读/写|命令序号|保留|CRC16校验|


### 编程实现

		串口收发如旧，主要为增加CRC校验，长查表法需要按照指定多项式，计算出长表，该长表多种渠道均可找到：

![[Pasted image 20230831102320.png]]

		CRC校验代码如下：

```C
u16 CRC16(unsigned char *ptr, unsigned char len)
{
    u16 crc;
    unsigned char da;
    crc=0;
    while(len--!=0)
    {
	    // 以8 位二进制数的形式暂存CRC 的高8 位
        da=(unsigned char) (crc/0x100);		
        // 左移8 位，相当于CRC 的低8 位乘以28
        crc<<=8; 							
        crc^=crc_ta[da^*ptr]; 	
        // 高8 位和当前字节相加后再查表求CRC,再加上以前的CRC		
        ptr++;
    }
    return(crc);
}
```

		通过CRC校验后，在对地址校验，直接判断接收的的首个数据地址即可。
		主要为命令校验，通过分析不同的命令码，设定不同的功能函数，其框架如下：

![[Pasted image 20230831102513.png]]


		上位机两帧之间的时间间隔约为17ms(波特率19200)，单片机设定定时器10ms后回复，实际回复时间10.8ms，理论下，上位机的1帧数据时长约为3.3ms,上位机两帧之间的时间间隔，会随着串口波特率的增加而缩短，115200时，两帧之间间隔14.60ms，由于设定1ms内呜下一位认为通信结束，因此当通信波特率低于14400时，将无法正常通讯。
		综上，
		1、串口判断为一个完整数据帧的等待时间；
		2、ARM的数据校验时间，数据发送时间
		两者合计在19200下，处理时间不易超过17ms
		在115200下，处理时间不宜超过14ms;
