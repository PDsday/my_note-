		W5500是内置了tcpip协议栈的网卡芯片，1也就是所谓的硬件协议栈，对应7层模型中的下三层(物理层，链路层，网络层)。
		它仅支持IPv4地址，使用方法简单，单片机利用SPI与该模块通信，此模块会将数据解包在封装成网络通信包，转化成光电信号发出去。


_协议栈其实是一系列协议的综合，因为他们有明确的前后关系，层层堆叠，先进后出所以统称协议栈，TCP/IP协议栈包括的协议有：应用层的Http，DNS，FTP；传输层的TCP/UDP协议，IP协议；网络层的ICMP协议，IGMP协议，ARP协议;甚至物理层，链路层等等诸多协议。_

1、传统的以太网接入方案
- MCU + 链路层MAC + 物理层PHY

![[Pasted image 20231023092853.png]]

		这种方案，需要MCU自行实现传输层，MAC和PHY则继承在其他模块中，比如ENC28J60，CS8900A等。又或者是STM32F7这种，自带MAC，只要一个PHY的芯片。软件协议栈需要MCU的中断不断的响应，一些性能比较低的MCU很难实现上述方案。
		即便是删减版的TCP/IP协议，LWIP协议，也会有超过40KB的代码量，对于本身内存资源匮乏的单片机来说负荷不小。

2、硬件协议栈

		硬件协议栈芯片方案，由一块继承MAC,PHY，以及网络层和传输层TCP/IP的芯片组成，单片机只需要将数据包交付给这块集成的通讯芯片即可。这种方案有韩国的WIZnet首次提出，并成功的退出以太网系列芯片：W5100，W5200，W5300和W5500。

![[Pasted image 20231023094929.png]]

		这套硬件内部的协议集成十分完善：

![[Pasted image 20231023095003.png]]

		这种硬件协议站在减少系统开销，节省内存有着巨大的优势，同时MCU不需要频繁的中断处理数据，让MCU专注在其他的任务处理，但他并非尽善尽美的。
		硬件化的协议栈毕竟没有软件协议栈零活，固化在硬件协议栈中的IP地址就是如此，目前即便是W5500也仅仅支持8个Socket接口，不能再开启更多的Socket。


---

### 1、W5500引脚图

![[Pasted image 20231023100817.png]]

		使用时，使用单片机的的SPI接口和此模块的SPI相连，使用4线spi方式，复位引脚低电平有效。


### 2、W5500初始化

>		W5500使用前，需要对寄存器参数做配置，并设置网络的基本信息。
>1、配置寄存器：
>		- 模式寄存器
>		- 中断屏蔽寄存器
>		- 重发事件寄存器
>		- 重发计数寄存器
>2、设置网络信息
>		- 网关地址寄存器
>		- 本机物理地址寄存器
>		- 子网掩码寄存器
>		- 本机IP地址寄存器
>3、设置端口缓冲区

设置前有必要了解W5500的地址配置

		W5500有一个通用寄存器和8个Socket寄存器区。其中每个Socket寄存器区又对应独立的收发缓存区。每个区域都可以通过SPI独立寻址，获取读写数据。Socket手环缓存器每个独立区域最大可分配16KB的物理地址范围，但总计不能超过0x0000到0xFFFF。

----

### 3、SPI工作模式
		W5500和外设主机的通讯收到SPI数据帧的控制。W5500主要常用可变数据长度模式，此模式下，片选信号拉低标识SPI帧起始，片选信号拉高标识SPI帧结束。
		W5500规定一段完整的SPI数据包括由三部分组成：

|地址段|控制段|数据段|
|:---:|:---:|:---:|
|16bit|8bit|N字节|

		  用户通过控制段的高5位，选择操控的寄存器，又通过16bit的地址段，选择对应寄存器的偏移地址，向指定的位置读写数据。

###### 控制段组成
		发送数据时，需要先规划控制段。

|BSB|RWB|OM|
|:---:|:---:|:---:|
|寄存器选择|0读/1写|OP Mode(数据长度模式)|
		
		数据长度模式设置00，选择不定长数据模式即可。固定长度模式不够灵活，非00均设置为固定长度模式:
		- 01:一个字节
		- 10：两个字节
		- 11：四个字节
		其中，最主要为BSB选择，寄存器前5个bit对应的部分寄存器表如下：

|BSB|含义|
|:---:|:---:|
|00000|选择通用定时器|
|00001|选择Socket0寄存器|
|00010|选择Socket0发送缓存|
|00011|选择Socket0接收缓存|
|00100|此处保留|
|00101|选择Socket1寄存器|
|00110|选择Socket1发送缓存|
|00111|选择Socket1接收缓存|
|01000|此处保留|
|01001|选择Socket2寄存器|
|01010|选择Socket2发送缓存|
|01011|选择Socket2接收缓存|
|01100|此处保留|
|....|....|

		套接字寄存器一个8个，每个对应一个接收缓存，发送缓存。规律重复可自行类推。

###### 选择通用定时
		设置好控制段BSB为00000后，需要再设置16bit的地址段，这是配置W5500的MAC地址，IP地址的重要步骤。
		通用寄存器的地址偏移如下:


![[Pasted image 20231023114720.png]]



		选择Socket寄存器，对应的地址偏移又如下：

![[Pasted image 20231023114846.png]]