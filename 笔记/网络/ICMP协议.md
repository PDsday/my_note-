>ICMP协议常常被认为是和IP协议处于同一层。
>这个协议，常常用来判断网络是否通畅。比如ping/traceroute命令。

---
## ICMP的作用
		ICMP 全称是 Internet Control Message Protocol ；
		互联网控制消息协议。在TCP/IP网络种，它负责发送控制消息，提供可能在通信环境种遇到的各种问题的反馈。网络管理者，通过对反馈信息的解析对网络问题做出诊断。

		数据自传输层进入网络层，就会被IP协议封装一堆IP包，形成一个数据包，又在数据链路层和物理层，经过ARP协议封装MAC帧，成为数据帧，最后通过物理层接口发出去。而ICMP,就作用在IP，和ARP之间。它的数据信息，会在封装IP包的时候，一起封装近数据包里，随着数据包一同向下。
		因此，如果捕捉IP包信息，查看他的 Protocol号是1的时候，就说明，你捕捉到一个携带ICMP信息的数据包了。

	不管是IP协议，PPP协议，ARP协议，他们都并非是可靠得通讯，所有的数据包都有机会丢失在茫茫互联网，而且，发送者并不知道数据包丢失了，因此也没有备份和重传。
	ICMP的存在可以认为是为了辅助IP协议的协议，他的数据包包含在IP包内，用来提高IP数据交成功的机会。仅仅是提高机会，并不能让IP协议成为可靠的协议。


## ICMP报文
		ICMP报文存在于IP数据报中的数据部分。前32个字分三部分，为类型，代码，校验和。后32个字将决定ICMP报文的类型，有差错报文和询问报文两种。


|类型|代码|校验和|
|:---:|:---:|:---:|
差错报文应当如下，询问报文也可以此类推：
![[Pasted image 20230227090212.png]]

#### 差错报文
差错报文能做到的功能为
- 终点不可到达
_路由器/主机无法交付数据报，就会向源点发送此报文_
- 源点抑制
_路由器/主机拥塞，丢弃IP数据报，会向源点发送抑制报文，让源点发送数据降低_
- 时间超过
_TTL时间为0时，丢弃该报文，同时向源点发送此报文_
_或者预定时间内，无法收到分组的全部报文，向源点发送此报文，同时丢弃已收到的数据分组_
- 参数问题
_IP首部有问题_
- 改变路由（重定向）
_让主机下次将数据报发送给其他路由，改变路径选择_

_**ICMP之所以不能让IP成为可靠协议，是因为差错报文存在一些不会回复的情况：**_
> ICMP报文本身出错；
> 只针对第一个数据报分片出错时有回复，后续分片出错也没有报文。一组数据报，只有一次纠错机会；
> 如果是目标地址是组播地址，也没有差错报文；
> 特殊地址也没有差错报文；
> TIPs:
> 差错报文还可以用来测试数据经过的路由器地址。过程如下，首先发送一个TTL为1的报文，它经过第一个路由器后死亡，第一个路由回发差错报文，获得第一个路由器的地址；随后，在发送一个TTL为2的报文，重复上述过程，获得第二个路由器的地址；不断增加TTL报文的时间，依次就可获得路径路由的地址信息。是Traceroute命令的原理。


#### 询问报文
>询问报文的目的是 测试目标地址是否可到达，或者用于主机/路由同步时钟和时间测量。是PING命令的原理。

询问报文：
- 回答请求和回答报文
_主机/路由询问特定主机，目的主机收到该报文，必须给源主机发送回答报文_
- 时间戳请求和回答报文
_请求日期和时间_








